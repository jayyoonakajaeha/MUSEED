# Triplet Dataset 최적화 및 로직 수정 보고서

**작성일:** 2025년 12월 3일
**작성자:** Gemini Agent
**관련 파일:** `MUSEED/research/fma_triplet_dataset.py`

## 개요
MuQ 모델 파인튜닝을 위한 Triplet 데이터셋(`TripletFmaDataset`)의 학습 효율성을 높이고, 의도했던 학습 전략(Hard Negative Mining)이 제대로 동작하지 않던 치명적인 논리 오류를 수정했습니다.

## 1. Balanced Undersampling 도입 (학습 속도 및 불균형 해결)

### 기존 문제점
- 9만 개 이상의 전체 데이터를 매 에폭마다 순회하려 하여 학습 시간이 지나치게 오래 걸림.
- `WeightedRandomSampler`를 사용했으나, 확률적 접근이므로 배치 단위에서 완벽한 장르 균형을 보장하기 어려움.

### 변경 사항
- **Undersampling 전략 적용:** 전체 데이터를 다 쓰는 대신, **장르당 500개**의 샘플만 무작위로 추출하여 에폭을 구성하도록 변경했습니다.
- **구현:** `__init__`에 `samples_per_genre=500` 파라미터 추가.
- **Anchor 선택 로직:** `index % num_genres`를 사용하여 배치 내에서 모든 장르가 물리적으로 균등하게 포함되도록 강제했습니다.

### 기대 효과
- **학습 속도 대폭 향상:** 에폭당 데이터 크기가 90,000+개에서 약 8,000개(16개 장르 기준)로 줄어들어 빠른 실험과 반복이 가능해짐.
- **완벽한 클래스 균형:** 모든 장르가 동일한 횟수만큼 Anchor로 등장하여, 소수 장르(Minority Class)의 성능 저하를 방지.

## 2. Hard Negative Mining 로직 수정 (버그 픽스)

### 기존 문제점 (논리 오류)
- Negative 샘플을 찾을 때 "상위 속성은 같아야 한다"는 조건과 "하위 속성은 달라야 한다"는 조건을 설정하는 과정(`tags_to_match`)에서 모순이 발생.
- 이로 인해 조건을 만족하는 Negative를 찾지 못해, 대부분의 경우(90% 이상) 단순히 장르가 다른 **Easy Negative**를 랜덤으로 선택하는 Fallback 로직이 실행됨.
- 결과적으로 모델이 미세한 특징(악기 구성, 분위기 등)을 학습하지 못하고 장르 분류 수준에 머무를 위험이 있었음.

### 변경 사항
- **명시적 계층 구조 정의:** 난이도에 따른 명확한 매칭 요구사항(`match_requirements`)을 리스트로 정의했습니다.
    - **Level 1 (Hardest - Source 다름):** Genre, Valence, Energy, Mood가 **모두 같아야 함**.
    - **Level 2 (Hard - Energy 다름):** Genre, Valence, Mood가 같아야 함.
    - **Level 3 (Medium - Mood 다름):** Genre, Valence가 같아야 함.
    - ...
- **로직 단순화:** 복잡한 동적 태그 계산을 제거하고, 위 계층 표에 따라 필터링(`mask`)을 수행하도록 수정.

### 기대 효과
- **정교한 특징 학습:** 이제 모델은 장르가 같더라도 "악기 구성(Source)"이나 "에너지"가 다른 미세한 차이를 학습해야 하므로, 단순 분류를 넘어선 **음색/분위기 기반의 유사도**를 학습할 수 있게 됨.
